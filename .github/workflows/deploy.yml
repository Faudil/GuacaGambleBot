name: Deploy to OVH

on:
  push:
    branches:
      - main  # Or 'master', depending on your default branch name

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Copy files via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.OVH_HOST }}
          username: ${{ secrets.OVH_USERNAME }}
          key: ${{ secrets.OVH_SSH_KEY }}
          # We only copy the necessary files
          source: "main.py,Dockerfile,requirements.txt,docker-compose.yml"
          target: "~/guacabot"

      # Step 2: Connect via SSH to build and run
      - name: Deploy on Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.OVH_HOST }}
          username: ${{ secrets.OVH_USERNAME }}
          key: ${{ secrets.OVH_SSH_KEY }}
          script: |
            # Go to the folder
            cd ~/guacabot
            
            # Create the .env file dynamically using the GitHub Secret
            # This ensures your token is never exposed in the repo
            echo "DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}" > .env

            # Build and Start the container
            # -d = Detached (background)
            # --build = Rebuild the image with new code
            docker-compose up -d --build

            docker image prune -f